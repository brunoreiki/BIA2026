{"version":3,"sources":["../src/studentfeedback.js"],"names":["define","$","url","cfg","log","setup","divID","ajaxParams","$feedbackarea","$submit","$cancel","$edit","setEditing","editing","toggle","is","removeAttr","attr","preventUnsavedChangesUnload","event","preventDefault","returnValue","change","window","addEventListener","val","data","click","ajax","relativeUrl","async","dataType","extend","feedback","encodeURIComponent","method","done","response","success","addClass","removeEventListener","error","fail","setupForQuestion","attemptStepID","qasid","sesskey","isgeneral","setupForQuiz"],"mappings":"AAoBAA,QAAQ,SAAU,WAAY,cAAe,YAAa,SAASC,EAAGC,EAAKC,EAAKC,GAO5E,SAASC,EAAMC,EAAOC,GAClB,IAAIC,EAAgBP,EAAE,IAAMK,EAAQ,mBAChCG,EAAUR,EAAE,IAAMK,EAAQ,qBAC1BI,EAAUT,EAAE,IAAMK,EAAQ,qBAC1BK,EAAQV,EAAE,IAAMK,EAAQ,mBAExBM,EAAa,SAASC,GAEtBF,EAAMG,QAAQD,GACdJ,EAAQK,OAAOD,GACfH,EAAQI,OAAOD,GAAWL,EAAcO,GAAG,eACvCF,EACAL,EAAcQ,WAAW,YAEzBR,EAAcS,KAAK,WAAY,aAKnCC,EAA8B,SAASC,GACvCA,EAAMC,iBACND,EAAME,YAAc,IAExBb,EAAcc,OAAO,WACjBC,OAAOC,iBAAiB,eAAgBN,KAG5CN,GAAYJ,EAAcO,GAAG,eAAiBP,EAAciB,OAASjB,EAAckB,KAAK,UAExFjB,EAAQkB,MAAM,WACV1B,EAAE2B,MACE1B,IAAKA,EAAI2B,YAAY,mFACrBC,OAAO,EACPC,SAAU,OACVL,KAAMzB,EAAE+B,WAAYC,SAAUC,mBAAmB1B,EAAciB,QAASlB,GACxE4B,OAAQ,SAEXC,KAAK,SAASC,GACPA,EAASC,SAET9B,EAAckB,KAAK,QAASlB,EAAciB,OAC1CjB,EAAc+B,SAAS,aACvB3B,GAAW,GAEXW,OAAOiB,oBAAoB,eAAgBtB,IAE3Cd,EAAIqC,MAAMJ,EAASI,SAG1BC,KAAKtC,EAAIqC,SAGd9B,EAAMgB,MAAM,WACRf,GAAW,KAGfF,EAAQiB,MAAM,WACVnB,EAAciB,IAAIjB,EAAckB,KAAK,UACrCd,GAAW,GAEXW,OAAOiB,oBAAoB,eAAgBtB,KAInD,OACIyB,iBAAkB,SAASrC,EAAOsC,GAC9BvC,EAAMC,GACFuC,MAAOD,EACPE,QAAS3C,EAAI2C,QACbC,UAAW,KAGnBC,aAAc,SAAS1C,EAAOsC,GAC1BvC,EAAMC,GACFuC,MAAOD,EACPE,QAAS3C,EAAI2C,QACbC,UAAW","file":"studentfeedback.min.js","sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Defines behaviour of student feedback fields (edition and submission).\n * @copyright  2021 Astor Bizard <astor.bizard@univ-grenoble-alpes.fr>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/url', 'core/config', 'core/log'], function($, url, cfg, log) {\n\n    /**\n     * Sets up the student feedback fields (a text area and buttons).\n     * @param {String} divID The html id of the element containinf the area and buttons.\n     * @param {Object} ajaxParams Parameters to be appended to ajax call when submitting feedback.\n     */\n    function setup(divID, ajaxParams) {\n        var $feedbackarea = $('#' + divID + ' .feedback-area');\n        var $submit = $('#' + divID + ' .submit-feedback');\n        var $cancel = $('#' + divID + ' .cancel-feedback');\n        var $edit = $('#' + divID + ' .edit-feedback');\n\n        var setEditing = function(editing) {\n            // Toggle the visibility / availability of every button / text area.\n            $edit.toggle(!editing);\n            $submit.toggle(editing);\n            $cancel.toggle(editing && $feedbackarea.is('.populated'));\n            if (editing) {\n                $feedbackarea.removeAttr('disabled');\n            } else {\n                $feedbackarea.attr('disabled', 'disabled');\n            }\n        };\n\n        // Prompt user before leaving the page if some changes have been made to feedback areas.\n        var preventUnsavedChangesUnload = function(event) {\n            event.preventDefault();\n            event.returnValue = '';\n        };\n        $feedbackarea.change(function() {\n            window.addEventListener('beforeunload', preventUnsavedChangesUnload);\n        });\n\n        setEditing(!$feedbackarea.is('.populated') || $feedbackarea.val() != $feedbackarea.data('value'));\n\n        $submit.click(function() {\n            $.ajax({\n                url: url.relativeUrl('/question/behaviour/studentfeedbackdeferred/ajax/submitstudentfeedback.json.php'),\n                async: false,\n                dataType: 'json',\n                data: $.extend({}, {feedback: encodeURIComponent($feedbackarea.val())}, ajaxParams),\n                method: 'post'\n            })\n            .done(function(response) {\n                if (response.success) {\n                    // Store value in attribute data-value to handle cancel.\n                    $feedbackarea.data('value', $feedbackarea.val());\n                    $feedbackarea.addClass('populated');\n                    setEditing(false);\n                    // Changes have been saved, don't prompt the user anymore.\n                    window.removeEventListener('beforeunload', preventUnsavedChangesUnload);\n                } else {\n                    log.error(response.error);\n                }\n            })\n            .fail(log.error);\n        });\n\n        $edit.click(function() {\n            setEditing(true);\n        });\n\n        $cancel.click(function() {\n            $feedbackarea.val($feedbackarea.data('value'));\n            setEditing(false);\n            // The cancel has been explicitely requested, don't prompt the user anymore.\n            window.removeEventListener('beforeunload', preventUnsavedChangesUnload);\n        });\n    }\n\n    return {\n        setupForQuestion: function(divID, attemptStepID) {\n            setup(divID, {\n                qasid: attemptStepID,\n                sesskey: cfg.sesskey,\n                isgeneral: 0\n            });\n        },\n        setupForQuiz: function(divID, attemptStepID) {\n            setup(divID, {\n                qasid: attemptStepID,\n                sesskey: cfg.sesskey,\n                isgeneral: 1\n            });\n        }\n    };\n});"]}